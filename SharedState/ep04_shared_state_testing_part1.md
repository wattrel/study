# Shared State: Testing, Part 1
일시: 1월 20일 오후 10시

@김성현

참조타입을 사용해서 공유 상태를 잘 처리했지만, 이제 테스트가 문제가 된다.
참조 타입은 값 복사본을 만들지 않기 때문에, 이전 상태와 새로운 상태를 참조의 복사본으로는 비교할 수가 없다.

snapshot 값을 둠으로서 테스트 시 같은 참조 값으로도 쉽게 비교할 수 있다.
테크닉:
TaskLocal을 사용해서 테스트 환경을 구분해서 스냅샷에 set할지와 스냅샷과 비교할지를 결정하도록 한다.

여전히 참조 타입의 이전값 기반의 변경은(예: increment) 테스트에 문제가 있다:
액션에서 한번 실행되고, 테스트 어썰션에서 한번 더 실행하니 문제가 되는 것이다.
이를 해결하기 위해 get 시에도 스냅샷을 반환하도록 분기를 처리한다.

+문제: 공유 상태만 변경되었을 때 테스트스토어가 상태변화가 있었다고 감지하지 못함
changeTracker를 두어 변경이 발생했을 때 실행되도록 하고 그걸 기반으로 변경됨을 TestStore가 알 수 있도록 수정.

+문제: 공유 상태가 전혀 바뀌지 않아 snapshot이 nil인 경우 처리 불가
equatable 구현에 snapshot이 nil일 때 기본값 처리를 해준다.

+문제: 테스트 환경이 아닐때 불필요한 리소스 사용
changeTracker를 옵셔널로 변경하여 트래킹 환경이 아닐때 snapshot 복사를 차단.

@홍승현

@윤용운
